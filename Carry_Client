--Client
local self = script.Parent
local events = game.ReplicatedStorage.Events
local carry_event = events.Carry

local UIS = game:GetService("UserInputService")
local localPlayer = game.Players.LocalPlayer
local CurrentCamera = workspace.CurrentCamera
local mouse = localPlayer:GetMouse()
local RunService = game:GetService("RunService")

local CarryPoint
local AlignPosition
local Object

local limitDistance = 6
local ping

local function findCarriableAncestor(target)
	local current = target
	while current do
		if current:IsA("BasePart") then
			if current:FindFirstChild("CarryPoint") then
				if current:FindFirstChild("CarryPoint"):IsA("Attachment") then
					CarryPoint = current:FindFirstChild("CarryPoint")
					return current
				else
					warn("CarryPoint must be an Attachment!")
					return nil
				end
			end
		elseif current:IsA("Model") then
			local primarypart = current.PrimaryPart
			if primarypart then
				if primarypart:FindFirstChild("CarryPoint") then
					if primarypart:FindFirstChild("CarryPoint"):IsA("Attachment") then
						CarryPoint = primarypart:FindFirstChild("CarryPoint")
						return current
					else
						warn("CarryPoint must be an Attachment!")
						return nil
					end
				end
			end
		end
		current = current.Parent
	end
	return nil
end

local function Carrying(Object)
	if Object:IsA("Model") then
		if Object.PrimaryPart.CollisionGroup == "SelfUncollide" then
			return true
		else
			return false
		end
	else
		if Object.CollisionGroup == "SelfUncollide" then
			return true
		else
			return false
		end
	end
end

local IsCarrying = false

UIS.InputBegan:Connect(function(input, isChatting)
	if isChatting then return end
	if input.UserInputType == Enum.UserInputType.MouseButton1 and Object == nil then
		local Target = mouse.Target
		Object = findCarriableAncestor(Target)
		if Object then
			if Carrying(Object) == false then
				IsCarrying = true
				while IsCarrying do
					local camCFrame = CurrentCamera.CFrame
					carry_event:InvokeServer(true, Object, camCFrame)
				end
			end
		end
	end
end)

UIS.InputEnded:Connect(function(input, isChatting)
	if isChatting then return end
	if input.UserInputType == Enum.UserInputType.MouseButton1 and Object then 
		IsCarrying = false
		carry_event:InvokeServer(false, Object, camCFrame)
		Object = nil
	end
end)
