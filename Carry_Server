local events = game.ReplicatedStorage.Events
local carry_event = events.Carry
local Carry
local Carry_Orientation
local Attachment0
local initialCamCFrame
local initialOrientation
local initialOrientationOffset

carry_event.OnServerInvoke = function(plr, IsCarrying, Object, camPos, camCFrame, delta_X, delta_Y)
	if Object then
		if IsCarrying then
			if not Object:FindFirstChild("Carry") then
				for i, part in pairs(Object:GetDescendants()) do
					if part:IsA("BasePart") then
						part.CollisionGroup = "SelfUncollide"
					end
				end
				Carry = Instance.new("AlignPosition", Object)
				Carry_Orientation = Instance.new("AlignOrientation", Object)
				Attachment0 = Instance.new("Attachment", Object)
				Attachment0.Name = "Carry_Attachment0"
				Carry.Name = "Carry"
				Carry.MaxForce = 10^6
				Carry.MaxVelocity = math.huge
				Carry.Responsiveness = 100
				Carry.ApplyAtCenterOfMass = true
				Carry.Mode = Enum.PositionAlignmentMode.OneAttachment

				Carry_Orientation.Name = "Carry_Orientation"
				Carry_Orientation.MaxTorque = 10^6
				Carry_Orientation.MaxAngularVelocity = math.huge
				Carry_Orientation.Responsiveness = 50
				Carry_Orientation.Mode = Enum.OrientationAlignmentMode.OneAttachment

				Carry.Attachment0 = Attachment0
				Carry_Orientation.Attachment0 = Attachment0

				-- Calculate and store the initial orientation offset
				initialCamCFrame = camCFrame
				initialOrientation = Object.CFrame
				Object.Anchored = false
				Object:SetNetworkOwner(plr)
			else
				Carry = Object:FindFirstChild("Carry")
				Carry_Orientation = Object:FindFirstChild("Carry_Orientation")
			end
			Carry.Position = camPos
			-- Apply the initial orientation offset relative to the current camera orientation
			Carry_Orientation.CFrame = (camCFrame * CFrame.Angles(math.rad(delta_X), 0, 0)) * ((initialCamCFrame * CFrame.Angles(0, math.rad(delta_Y), 0)):ToObjectSpace(initialOrientation))
		else
			Carry:Destroy()
			Carry_Orientation:Destroy()
			Object:SetNetworkOwner(nil)
			Attachment0:Destroy()
			for i, part in pairs(Object:GetDescendants()) do
				if part:IsA("BasePart") then
					part.CollisionGroup = "Default"
				end
			end
		end
	end
end
